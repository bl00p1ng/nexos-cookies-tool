import { app, BrowserWindow, ipcMain, dialog, shell, Menu } from 'electron';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import Store from 'electron-store';

// Importar servicios del core
import ConfigManager from '../core/config/ConfigManager.js';
import DatabaseManager from '../core/database/DatabaseManager.js';
import AdsPowerManager from '../core/adspower/AdsPowerManager.js';
import NavigationController from '../core/navigation/NavigationController.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Proceso principal de Electron para Nexos Cookies Tool
 * Maneja la ventana principal, autenticaci√≥n y coordinaci√≥n con el core
 */
class ElectronApp {
    constructor() {
        this.mainWindow = null;
        this.isAuthenticated = false;
        this.userToken = null;
        this.userData = null;
        
        // Store para persistir configuraci√≥n
        this.store = new Store({
            schema: {
                authToken: { type: 'string' },
                lastEmail: { type: 'string' },
                windowBounds: {
                    type: 'object',
                    properties: {
                        x: { type: 'integer' },
                        y: { type: 'integer' },
                        width: { type: 'integer' },
                        height: { type: 'integer' }
                    }
                }
            }
        });

        // Inicializar servicios del core
        this.configManager = new ConfigManager();
        this.databaseManager = null;
        this.adsPowerManager = null;
        this.navigationController = null;
    }

    /**
     * Inicializa la aplicaci√≥n Electron
     */
    async initialize() {
        try {
            console.log('üöÄ Iniciando Nexos Cookies Tool...');

            // Configurar eventos de la aplicaci√≥n
            this.setupAppEvents();

            // Configurar IPC handlers
            this.setupIpcHandlers();

            // Inicializar servicios del core
            await this.initializeCoreServices();

            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');

        } catch (error) {
            console.error('‚ùå Error inicializando aplicaci√≥n:', error.message);
            this.showErrorDialog('Error de Inicializaci√≥n', error.message);
        }
    }

    /**
     * Configura eventos de la aplicaci√≥n Electron
     */
    setupAppEvents() {
        // Cuando la app est√© lista
        app.whenReady().then(() => {
            this.createMainWindow();
            this.createApplicationMenu();
        });

        // Cuando todas las ventanas se cierran
        app.on('window-all-closed', () => {
            if (process.platform !== 'darwin') {
                app.quit();
            }
        });

        // Cuando la app se activa (macOS)
        app.on('activate', () => {
            if (BrowserWindow.getAllWindows().length === 0) {
                this.createMainWindow();
            }
        });

        // Antes de cerrar la aplicaci√≥n
        app.on('before-quit', async () => {
            await this.cleanup();
        });
    }

    /**
     * Crea la ventana principal
     */
    createMainWindow() {
        // Recuperar bounds guardados o usar valores por defecto
        const defaultBounds = { width: 1200, height: 800, x: undefined, y: undefined };
        const savedBounds = this.store.get('windowBounds', defaultBounds);

        this.mainWindow = new BrowserWindow({
            ...savedBounds,
            minWidth: 800,
            minHeight: 600,
            webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                enableRemoteModule: false,
                preload: join(__dirname, 'preload.js')
            },
            icon: join(__dirname, '../assets/icon.png'),
            show: false,
            titleBarStyle: process.platform === 'darwin' ? 'hiddenInset' : 'default'
        });

        // Cargar interfaz de usuario
        this.mainWindow.loadFile(join(__dirname, '../ui/index.html'));

        // Mostrar cuando est√© listo
        this.mainWindow.once('ready-to-show', () => {
            this.mainWindow.show();
            
            // Verificar autenticaci√≥n al inicio
            this.checkExistingAuth();
        });

        // Guardar posici√≥n de ventana al cerrar
        this.mainWindow.on('close', () => {
            const bounds = this.mainWindow.getBounds();
            this.store.set('windowBounds', bounds);
        });

        // Abrir enlaces externos en navegador por defecto
        this.mainWindow.webContents.setWindowOpenHandler(({ url }) => {
            shell.openExternal(url);
            return { action: 'deny' };
        });

        // Configurar para desarrollo
        if (process.env.NODE_ENV === 'development') {
            this.mainWindow.webContents.openDevTools();
        }
    }

    /**
     * Crea el men√∫ de la aplicaci√≥n
     */
    createApplicationMenu() {
        const template = [
            {
                label: 'Archivo',
                submenu: [
                    {
                        label: 'Cerrar Sesi√≥n',
                        accelerator: 'CmdOrCtrl+L',
                        click: () => this.handleLogout()
                    },
                    { type: 'separator' },
                    {
                        label: 'Salir',
                        accelerator: process.platform === 'darwin' ? 'Cmd+Q' : 'Ctrl+Q',
                        click: () => app.quit()
                    }
                ]
            },
            {
                label: 'Ver',
                submenu: [
                    { role: 'reload' },
                    { role: 'forceReload' },
                    { role: 'toggleDevTools' },
                    { type: 'separator' },
                    { role: 'resetZoom' },
                    { role: 'zoomIn' },
                    { role: 'zoomOut' },
                    { type: 'separator' },
                    { role: 'togglefullscreen' }
                ]
            },
            {
                label: 'Ayuda',
                submenu: [
                    {
                        label: 'Acerca de',
                        click: () => this.showAboutDialog()
                    }
                ]
            }
        ];

        const menu = Menu.buildFromTemplate(template);
        Menu.setApplicationMenu(menu);
    }

    /**
     * Configura manejadores IPC
     */
    setupIpcHandlers() {
        // Autenticaci√≥n
        ipcMain.handle('auth:request-code', this.handleRequestCode.bind(this));
        ipcMain.handle('auth:verify-code', this.handleVerifyCode.bind(this));
        ipcMain.handle('auth:logout', this.handleLogout.bind(this));
        ipcMain.handle('auth:get-status', this.getAuthStatus.bind(this));

        // Ads Power
        ipcMain.handle('adspower:check-status', this.checkAdsPowerStatus.bind(this));
        ipcMain.handle('adspower:list-profiles', this.listAdsPowerProfiles.bind(this));
        ipcMain.handle('adspower:profile-info', this.getProfileInfo.bind(this));

        // Navegaci√≥n
        ipcMain.handle('navigation:start', this.startNavigation.bind(this));
        ipcMain.handle('navigation:stop', this.stopNavigation.bind(this));
        ipcMain.handle('navigation:get-status', this.getNavigationStatus.bind(this));

        // Base de datos
        ipcMain.handle('database:get-stats', this.getDatabaseStats.bind(this));
        ipcMain.handle('database:get-sites', this.getRandomSites.bind(this));

        // Configuraci√≥n
        ipcMain.handle('config:get', this.getConfiguration.bind(this));
        ipcMain.handle('config:update', this.updateConfiguration.bind(this));

        // Sistema
        ipcMain.handle('system:show-folder', this.showDataFolder.bind(this));
        ipcMain.handle('system:export-logs', this.exportLogs.bind(this));
    }

    /**
     * Inicializa servicios del core
     */
    async initializeCoreServices() {
        try {
            // Cargar configuraci√≥n
            await this.configManager.loadConfig();

            // Inicializar base de datos
            this.databaseManager = new DatabaseManager(this.configManager);
            await this.databaseManager.initialize();

            // Inicializar Ads Power Manager
            this.adsPowerManager = new AdsPowerManager(this.configManager);

            // Inicializar Navigation Controller
            this.navigationController = new NavigationController(
                this.databaseManager,
                this.configManager
            );

            console.log('üîß Servicios del core inicializados');

        } catch (error) {
            console.error('‚ùå Error inicializando servicios:', error.message);
            throw error;
        }
    }

    /**
     * Verifica autenticaci√≥n existente al inicio
     */
    async checkExistingAuth() {
        try {
            const token = this.store.get('authToken');
            const lastEmail = this.store.get('lastEmail');

            if (token) {
                // Validar token con el backend
                const isValid = await this.validateToken(token);
                if (isValid) {
                    this.isAuthenticated = true;
                    this.userToken = token;
                    this.mainWindow.webContents.send('auth:authenticated', {
                        email: lastEmail,
                        token: token
                    });
                    return;
                }
            }

            // Si no hay token v√°lido, mostrar pantalla de login
            this.mainWindow.webContents.send('auth:show-login');

        } catch (error) {
            console.error('Error verificando autenticaci√≥n:', error.message);
            this.mainWindow.webContents.send('auth:show-login');
        }
    }

    /**
     * Maneja solicitud de c√≥digo de acceso
     */
    async handleRequestCode(event, email) {
        try {
            console.log(`üìß Solicitando c√≥digo para: ${email}`);

            // Hacer petici√≥n al backend de autenticaci√≥n
            const response = await fetch('http://localhost:3001/api/auth/request-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email })
            });

            const result = await response.json();

            if (response.ok) {
                // Guardar email para recordar
                this.store.set('lastEmail', email);
                return { success: true, message: result.message };
            } else {
                return { success: false, error: result.error };
            }

        } catch (error) {
            console.error('Error solicitando c√≥digo:', error.message);
            return { 
                success: false, 
                error: 'Error de conexi√≥n. Verifica que el servidor de autenticaci√≥n est√© ejecut√°ndose.' 
            };
        }
    }

    /**
     * Maneja verificaci√≥n de c√≥digo
     */
    async handleVerifyCode(event, email, code) {
        try {
            console.log(`üîë Verificando c√≥digo para: ${email}`);

            // TODO: Reemplazar URL con la del backend real
            const response = await fetch('http://localhost:3001/api/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, code })
            });

            const result = await response.json();

            if (response.ok) {
                // Guardar token y datos de usuario
                this.isAuthenticated = true;
                this.userToken = result.data.token;
                this.userData = result.data.user;
                
                this.store.set('authToken', result.data.token);
                this.store.set('lastEmail', email);

                return { 
                    success: true, 
                    user: result.data.user,
                    token: result.data.token
                };
            } else {
                return { success: false, error: result.error };
            }

        } catch (error) {
            console.error('Error verificando c√≥digo:', error.message);
            return { 
                success: false, 
                error: 'Error de conexi√≥n con el servidor de autenticaci√≥n.' 
            };
        }
    }

    /**
     * Valida token con el backend
     */
    async validateToken(token) {
        try {
            // TODO: Reemplazar URL con la del backend real
            const response = await fetch('http://localhost:3001/api/auth/validate-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token })
            });

            return response.ok;

        } catch (error) {
            console.error('Error validando token:', error.message);
            return false;
        }
    }

    /**
     * Maneja logout
     */
    async handleLogout() {
        this.isAuthenticated = false;
        this.userToken = null;
        this.userData = null;
        
        this.store.delete('authToken');
        
        this.mainWindow.webContents.send('auth:logged-out');
    }

    /**
     * Obtiene estado de autenticaci√≥n
     */
    getAuthStatus() {
        return {
            isAuthenticated: this.isAuthenticated,
            user: this.userData
        };
    }

    /**
     * Verifica estado de Ads Power
     */
    async checkAdsPowerStatus() {
        try {
            const status = await this.adsPowerManager.checkApiStatus();
            return { success: true, status };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Lista perfiles de Ads Power
     */
    async listAdsPowerProfiles() {
        try {
            const profiles = await this.adsPowerManager.listProfiles();
            return { success: true, profiles };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene informaci√≥n de perfil espec√≠fico
     */
    async getProfileInfo(event, profileId) {
        try {
            const info = await this.adsPowerManager.getProfileInfo(profileId);
            return { success: true, info };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Inicia navegaci√≥n
     */
    async startNavigation(event, config) {
        try {
            if (!this.isAuthenticated) {
                throw new Error('Usuario no autenticado');
            }

            console.log('üöÄ Iniciando navegaci√≥n con configuraci√≥n:', config);

            const result = await this.navigationController.startMultipleNavigationSessions(
                config.profileIds,
                config.targetCookies
            );

            return { success: true, result };

        } catch (error) {
            console.error('Error iniciando navegaci√≥n:', error.message);
            return { success: false, error: error.message };
        }
    }

    /**
     * Detiene navegaci√≥n
     */
    async stopNavigation() {
        try {
            await this.navigationController.stopAllSessions();
            return { success: true };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene estado de navegaci√≥n
     */
    getNavigationStatus() {
        try {
            const status = this.navigationController.getGlobalStats();
            return { success: true, status };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene estad√≠sticas de base de datos
     */
    async getDatabaseStats() {
        try {
            const stats = await this.databaseManager.getWebsiteStats();
            return { success: true, stats };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene sitios aleatorios
     */
    async getRandomSites(event, count = 10) {
        try {
            const sites = await this.databaseManager.getRandomWebsites(count);
            return { success: true, sites };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene configuraci√≥n
     */
    getConfiguration() {
        return this.configManager.getConfig();
    }

    /**
     * Actualiza configuraci√≥n
     */
    async updateConfiguration(event, updates) {
        try {
            Object.keys(updates).forEach(key => {
                this.configManager.set(key, updates[key]);
            });
            
            await this.configManager.saveConfig();
            return { success: true };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Muestra carpeta de datos
     */
    async showDataFolder() {
        const dataPath = this.configManager.getDatabasePath();
        shell.showItemInFolder(dataPath);
    }

    /**
     * Exporta logs
     */
    async exportLogs() {
        try {
            const result = await dialog.showSaveDialog(this.mainWindow, {
                defaultPath: `nexos-logs-${new Date().toISOString().split('T')[0]}.txt`,
                filters: [
                    { name: 'Archivos de texto', extensions: ['txt'] },
                    { name: 'Todos los archivos', extensions: ['*'] }
                ]
            });

            if (!result.canceled) {
                // Aqu√≠ implementar√≠as la exportaci√≥n de logs
                return { success: true, path: result.filePath };
            }

            return { success: false, error: 'Exportaci√≥n cancelada' };

        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Muestra di√°logo de error
     */
    showErrorDialog(title, message) {
        dialog.showErrorBox(title, message);
    }

    /**
     * Muestra di√°logo "Acerca de"
     */
    showAboutDialog() {
        dialog.showMessageBox(this.mainWindow, {
            type: 'info',
            title: 'Acerca de Nexos Cookies Tool',
            message: 'Nexos Cookies Tool v1.0.0',
            detail: 'Sistema automatizado para calentar contingencias\n¬© 2025 Todos los derechos reservados.'
        });
    }

    /**
     * Limpieza antes de cerrar
     */
    async cleanup() {
        try {
            console.log('üßπ Limpiando recursos...');
            
            if (this.navigationController) {
                await this.navigationController.stopAllSessions();
            }
            
            if (this.adsPowerManager) {
                await this.adsPowerManager.cleanup();
            }

            if (this.databaseManager) {
                await this.databaseManager.close();
            }

            console.log('‚úÖ Limpieza completada');

        } catch (error) {
            console.error('Error en limpieza:', error.message);
        }
    }
}

// Inicializar aplicaci√≥n
const electronApp = new ElectronApp();

// Prevenir creaci√≥n de ventanas adicionales para URLs
app.on('web-contents-created', (event, contents) => {
    contents.on('new-window', (event, navigationUrl) => {
        event.preventDefault();
        shell.openExternal(navigationUrl);
    });
});

// Inicializar cuando la app est√© lista
app.whenReady().then(() => {
    electronApp.initialize();
});