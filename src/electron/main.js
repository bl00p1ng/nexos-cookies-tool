import { app, BrowserWindow, ipcMain, dialog, shell, Menu } from 'electron';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import Store from 'electron-store';
import axios from 'axios';

// Importar servicios del core
import ConfigManager from '../core/config/ConfigManager.js';
import DatabaseManager from '../core/database/DatabaseManager.js';
import AdsPowerManager from '../core/adspower/AdsPowerManager.js';
import NavigationController from '../core/navigation/NavigationController.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Proceso principal de Electron para Cookies Hexzor
 * Maneja la ventana principal, autenticaci√≥n persistente y coordinaci√≥n con el core
 */
class ElectronApp {
    constructor() {
        this.mainWindow = null;
        this.isAuthenticated = false;
        this.userToken = null;
        this.userData = null;
        this.authBackendUrl = process.env.AUTH_BACKEND_URL || 'http://localhost:3001';
        
        // Store para persistir configuraci√≥n y autenticaci√≥n
        this.store = new Store({
            schema: {
                authToken: { type: 'string' },
                lastEmail: { type: 'string' },
                subscriptionEnd: { type: 'string' },
                tokenExpiry: { type: 'string' },
                customerName: { type: 'string' },
                customerId: { type: 'string' },
                windowBounds: {
                    type: 'object',
                    properties: {
                        x: { type: 'integer' },
                        y: { type: 'integer' },
                        width: { type: 'integer' },
                        height: { type: 'integer' }
                    }
                }
            }
        });

        // Inicializar servicios del core
        this.configManager = new ConfigManager();
        this.databaseManager = null;
        this.adsPowerManager = null;
        this.navigationController = null;
    }

    /**
     * Inicializa la aplicaci√≥n Electron
     */
    async initialize() {
        try {
            console.log('üöÄ Iniciando Cookies Hexzor...');

            // Configurar eventos de la aplicaci√≥n
            this.setupAppEvents();

            // Configurar IPC handlers
            this.setupIpcHandlers();

            // Inicializar servicios del core
            await this.initializeCoreServices();

            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');

        } catch (error) {
            console.error('‚ùå Error inicializando aplicaci√≥n:', error.message);
            this.showErrorDialog('Error de Inicializaci√≥n', error.message);
        }
    }

    /**
     * Configura eventos de la aplicaci√≥n Electron
     */
    setupAppEvents() {
        // Cuando la app est√© lista
        app.whenReady().then(() => {
            this.createMainWindow();
            this.createApplicationMenu();
        });

        // Cuando todas las ventanas est√©n cerradas
        app.on('window-all-closed', () => {
            if (process.platform !== 'darwin') {
                app.quit();
            }
        });

        // Al activar (macOS)
        app.on('activate', () => {
            if (BrowserWindow.getAllWindows().length === 0) {
                this.createMainWindow();
            }
        });

        // Antes de cerrar
        app.on('before-quit', async () => {
            await this.cleanup();
        });
    }

    /**
     * Crea la ventana principal
     */
    createMainWindow() {
        // Obtener bounds guardados o usar valores por defecto
        const bounds = this.store.get('windowBounds', {
            width: 1200,
            height: 800,
            x: undefined,
            y: undefined
        });

        // Crear ventana principal
        this.mainWindow = new BrowserWindow({
            ...bounds,
            minWidth: 800,
            minHeight: 600,
            webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                preload: join(__dirname, 'preload.js')
            },
            titleBarStyle: 'default',
            show: false // No mostrar hasta que est√© lista
        });

        // Cargar interfaz
        this.mainWindow.loadFile(join(__dirname, '../ui/index.html'));

        // Mostrar cuando est√© lista
        this.mainWindow.once('ready-to-show', () => {
            this.mainWindow.show();
            this.checkExistingAuth();
        });

        // Guardar bounds al cerrar
        this.mainWindow.on('close', () => {
            const bounds = this.mainWindow.getBounds();
            this.store.set('windowBounds', bounds);
        });

        // Para desarrollo: abrir DevTools autom√°ticamente
        if (process.env.NODE_ENV === 'development') {
            this.mainWindow.webContents.openDevTools();
        }
    }

    /**
     * Crea el men√∫ de la aplicaci√≥n
     */
    createApplicationMenu() {
        const template = [
            {
                label: 'Archivo',
                submenu: [
                    {
                        label: 'Cerrar sesi√≥n',
                        accelerator: process.platform === 'darwin' ? 'Cmd+L' : 'Ctrl+L',
                        click: () => this.handleLogout()
                    },
                    { type: 'separator' },
                    {
                        label: 'Salir',
                        accelerator: process.platform === 'darwin' ? 'Cmd+Q' : 'Ctrl+Q',
                        click: () => app.quit()
                    }
                ]
            },
            {
                label: 'Ver',
                submenu: [
                    { role: 'reload' },
                    { role: 'forceReload' },
                    { role: 'toggleDevTools' },
                    { type: 'separator' },
                    { role: 'resetZoom' },
                    { role: 'zoomIn' },
                    { role: 'zoomOut' },
                    { type: 'separator' },
                    { role: 'togglefullscreen' }
                ]
            },
            {
                label: 'Ayuda',
                submenu: [
                    {
                        label: 'Acerca de',
                        click: () => this.showAboutDialog()
                    }
                ]
            }
        ];

        const menu = Menu.buildFromTemplate(template);
        Menu.setApplicationMenu(menu);
    }

    /**
     * Configura manejadores IPC
     */
    setupIpcHandlers() {
        // Autenticaci√≥n
        ipcMain.handle('auth:request-code', this.handleRequestCode.bind(this));
        ipcMain.handle('auth:verify-code', this.handleVerifyCode.bind(this));
        ipcMain.handle('auth:logout', this.handleLogout.bind(this));
        ipcMain.handle('auth:get-status', this.getAuthStatus.bind(this));

        // Ads Power
        ipcMain.handle('adspower:check-status', this.checkAdsPowerStatus.bind(this));
        ipcMain.handle('adspower:list-profiles', this.listAdsPowerProfiles.bind(this));
        ipcMain.handle('adspower:profile-info', this.getProfileInfo.bind(this));

        // Navegaci√≥n
        ipcMain.handle('navigation:start', this.startNavigation.bind(this));
        ipcMain.handle('navigation:stop', this.stopNavigation.bind(this));
        ipcMain.handle('navigation:get-status', this.getNavigationStatus.bind(this));

        // Base de datos
        ipcMain.handle('database:get-stats', this.getDatabaseStats.bind(this));
        ipcMain.handle('database:get-sites', this.getRandomSites.bind(this));

        // Configuraci√≥n
        ipcMain.handle('config:get', this.getConfiguration.bind(this));
        ipcMain.handle('config:update', this.updateConfiguration.bind(this));

        // Sistema
        ipcMain.handle('system:show-folder', this.showDataFolder.bind(this));
        ipcMain.handle('system:export-logs', this.exportLogs.bind(this));
    }

    /**
     * Inicializa servicios del core
     */
    async initializeCoreServices() {
        try {
            // Cargar configuraci√≥n
            await this.configManager.loadConfig();

            // Inicializar base de datos
            this.databaseManager = new DatabaseManager();
            await this.databaseManager.initialize();

            // Inicializar Ads Power Manager
            this.adsPowerManager = new AdsPowerManager(this.configManager);

            // Inicializar Navigation Controller
            this.navigationController = new NavigationController(
                this.databaseManager,
                this.configManager
            );

            console.log('üîß Servicios del core inicializados');

        } catch (error) {
            console.error('‚ùå Error inicializando servicios:', error.message);
            throw error;
        }
    }

    /**
     * Verifica autenticaci√≥n existente al inicio de la aplicaci√≥n
     * Solo pide re-autenticaci√≥n si es necesario
     */
    async checkExistingAuth() {
        try {
            console.log('üîê Verificando autenticaci√≥n existente...');

            const storedToken = this.store.get('authToken');
            const storedEmail = this.store.get('lastEmail');
            const tokenExpiry = this.store.get('tokenExpiry');
            const subscriptionEnd = this.store.get('subscriptionEnd');

            // Si no hay token guardado, mostrar login
            if (!storedToken || !storedEmail) {
                console.log('üìù No hay sesi√≥n guardada, mostrando login');
                this.mainWindow.webContents.send('auth:show-login');
                return;
            }

            // Verificar si el token ha expirado (tokens v√°lidos por 30 d√≠as)
            if (tokenExpiry) {
                const expiryDate = new Date(tokenExpiry);
                const now = new Date();
                
                if (now > expiryDate) {
                    console.log('‚è∞ Token expirado, requiere nueva autenticaci√≥n');
                    this.clearStoredAuth();
                    this.mainWindow.webContents.send('auth:show-login');
                    return;
                }
            }

            // Verificar si la suscripci√≥n ha expirado
            if (subscriptionEnd) {
                const subEndDate = new Date(subscriptionEnd);
                const now = new Date();
                
                if (now > subEndDate) {
                    console.log('üìÖ Suscripci√≥n expirada, requiere nueva autenticaci√≥n');
                    this.clearStoredAuth();
                    this.mainWindow.webContents.send('auth:show-login');
                    return;
                }
            }

            // Validar token con el backend
            const isValidToken = await this.validateTokenWithBackend(storedToken, storedEmail);
            
            if (isValidToken.success) {
                // Token v√°lido y suscripci√≥n activa
                this.isAuthenticated = true;
                this.userToken = storedToken;
                this.userData = {
                    email: storedEmail,
                    customerName: this.store.get('customerName'),
                    customerId: this.store.get('customerId'),
                    subscriptionEnd: subscriptionEnd
                };
                
                console.log('‚úÖ Sesi√≥n restaurada autom√°ticamente para:', storedEmail);
                
                this.mainWindow.webContents.send('auth:authenticated', {
                    email: storedEmail,
                    token: storedToken,
                    user: this.userData
                });
                
            } else {
                // Token inv√°lido o suscripci√≥n inactiva
                console.log('‚ùå Token inv√°lido o suscripci√≥n inactiva:', isValidToken.error);
                this.clearStoredAuth();
                this.mainWindow.webContents.send('auth:show-login');
            }

        } catch (error) {
            console.error('Error verificando autenticaci√≥n:', error.message);
            this.clearStoredAuth();
            this.mainWindow.webContents.send('auth:show-login');
        }
    }

    /**
     * Valida un token guardado con el backend de autenticaci√≥n
     */
    async validateTokenWithBackend(token, email) {
        try {
            const response = await axios.post(`${this.authBackendUrl}/api/auth/validate-token`, {
                token: token,
                email: email
            }, {
                timeout: 10000,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.data.success) {
                // Actualizar informaci√≥n de suscripci√≥n si ha cambiado
                const subscriptionData = response.data.subscription;
                if (subscriptionData && subscriptionData.subscriptionEnd) {
                    this.store.set('subscriptionEnd', subscriptionData.subscriptionEnd);
                    this.store.set('customerName', subscriptionData.customerName);
                    this.store.set('customerId', subscriptionData.customerId);
                }
                
                return { success: true };
            } else {
                return { success: false, error: response.data.error || 'Token inv√°lido' };
            }

        } catch (error) {
            if (error.response && error.response.status === 401) {
                return { success: false, error: 'Token expirado o inv√°lido' };
            }
            
            console.error('Error validando token:', error.message);
            return { success: false, error: 'Error de conexi√≥n con servidor de autenticaci√≥n' };
        }
    }

    /**
     * Limpia toda la informaci√≥n de autenticaci√≥n guardada
     */
    clearStoredAuth() {
        this.store.delete('authToken');
        this.store.delete('lastEmail');
        this.store.delete('subscriptionEnd');
        this.store.delete('tokenExpiry');
        this.store.delete('customerName');
        this.store.delete('customerId');
        
        this.isAuthenticated = false;
        this.userToken = null;
        this.userData = null;
    }

    //#region AUTENTICACI√ìN
    /**
     * Solicita c√≥digo de verificaci√≥n al backend
     */
    async handleRequestCode(event, email) {
        try {
            console.log('üìß Solicitando c√≥digo para:', email);

            const response = await axios.post(`${this.authBackendUrl}/api/auth/request-code`, {
                email: email
            }, {
                timeout: 15000,
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.data.success) {
                console.log('‚úÖ C√≥digo enviado exitosamente');
                return { 
                    success: true, 
                    message: response.data.message || 'C√≥digo enviado a tu email' 
                };
            } else {
                return { 
                    success: false, 
                    error: response.data.error || 'Error enviando c√≥digo'
                };
            }

        } catch (error) {
            console.error('Error solicitando c√≥digo:', error.message);
            
            if (error.response) {
                const status = error.response.status;
                const errorMsg = error.response.data?.error || 'Error del servidor';
                
                if (status === 404) {
                    return { success: false, error: 'Email no encontrado o sin suscripci√≥n activa' };
                } else if (status === 429) {
                    return { success: false, error: 'Demasiados intentos. Intenta m√°s tarde' };
                } else {
                    return { success: false, error: errorMsg };
                }
            }
            
            return { 
                success: false, 
                error: 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.' 
            };
        }
    }

    /**
     * Verifica c√≥digo de acceso con el backend
     */
    async handleVerifyCode(event, email, code) {
        try {
            console.log('üîê Verificando c√≥digo para:', email);

            const response = await axios.post(`${this.authBackendUrl}/api/auth/verify-code`, {
                email: email,
                code: code
            }, {
                timeout: 10000,
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.data.success) {
                const { token, user, subscription } = response.data;
                
                // Calcular fecha de expiraci√≥n del token (30 d√≠as)
                const tokenExpiry = new Date();
                tokenExpiry.setDate(tokenExpiry.getDate() + 30);
                
                // Guardar en store
                this.store.set('authToken', token);
                this.store.set('lastEmail', email);
                this.store.set('tokenExpiry', tokenExpiry.toISOString());
                
                if (subscription) {
                    this.store.set('subscriptionEnd', subscription.subscriptionEnd);
                    this.store.set('customerName', subscription.customerName);
                    this.store.set('customerId', subscription.customerId);
                }
                
                // Actualizar estado
                this.isAuthenticated = true;
                this.userToken = token;
                this.userData = {
                    email: email,
                    customerName: subscription?.customerName,
                    customerId: subscription?.customerId,
                    subscriptionEnd: subscription?.subscriptionEnd
                };
                
                console.log('‚úÖ Autenticaci√≥n exitosa para:', email);
                
                return { 
                    success: true, 
                    token,
                    user: this.userData
                };
                
            } else {
                return { 
                    success: false, 
                    error: response.data.error || 'C√≥digo inv√°lido' 
                };
            }

        } catch (error) {
            console.error('Error verificando c√≥digo:', error.message);
            
            if (error.response) {
                const status = error.response.status;
                const errorMsg = error.response.data?.error || 'Error del servidor';
                
                if (status === 401) {
                    return { success: false, error: 'C√≥digo inv√°lido o expirado' };
                } else if (status === 429) {
                    return { success: false, error: 'Demasiados intentos. Intenta m√°s tarde' };
                } else {
                    return { success: false, error: errorMsg };
                }
            }
            
            return { 
                success: false, 
                error: 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.' 
            };
        }
    }

    /**
     * Cierra sesi√≥n del usuario (manual)
     */
    async handleLogout() {
        try {
            console.log('üëã Cerrando sesi√≥n...');
            
            // Intentar notificar al backend (opcional, no falla si no se puede)
            try {
                if (this.userToken) {
                    await axios.post(`${this.authBackendUrl}/api/auth/logout`, {}, {
                        timeout: 5000,
                        headers: {
                            'Authorization': `Bearer ${this.userToken}`
                        }
                    });
                }
            } catch (error) {
                console.warn('No se pudo notificar logout al backend:', error.message);
            }
            
            // Limpiar estado local
            this.clearStoredAuth();
            
            // Notificar a la UI
            this.mainWindow.webContents.send('auth:logged-out');
            
            console.log('‚úÖ Sesi√≥n cerrada exitosamente');
            
            return { success: true };

        } catch (error) {
            console.error('Error cerrando sesi√≥n:', error.message);
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene estado de autenticaci√≥n actual
     */
    async getAuthStatus() {
        return {
            isAuthenticated: this.isAuthenticated,
            user: this.userData
        };
    }
    //#endregion AUTENTICACI√ìN

    //#region ADS POWER
    /**
     * Verifica estado de Ads Power
     */
    async checkAdsPowerStatus() {
        try {
            const isAvailable = await this.adsPowerManager.checkAdsPowerStatus();
            return { success: true, available: isAvailable };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Lista perfiles disponibles de Ads Power
     */
    async listAdsPowerProfiles() {
        try {
            const profiles = await this.adsPowerManager.getAvailableProfiles();
            return { success: true, profiles };
        } catch (error) {
            console.error('Error listando perfiles:', error.message);
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene informaci√≥n de perfil espec√≠fico
     */
    async getProfileInfo(event, profileId) {
        try {
            const info = await this.adsPowerManager.getProfileInfo(profileId);
            return { success: true, info };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    //#endregion ADS POWER

    //#region NAVEGACI√ìN
    /**
     * Inicia navegaci√≥n
     */
    async startNavigation(event, config) {
        try {
            if (!this.isAuthenticated) {
                throw new Error('Usuario no autenticado');
            }

            console.log('üöÄ Iniciando navegaci√≥n con configuraci√≥n:', config);

            const result = await this.navigationController.startMultipleNavigationSessions(
                config.profileIds,
                config.targetCookies
            );

            return { success: true, result };

        } catch (error) {
            console.error('Error iniciando navegaci√≥n:', error.message);
            return { success: false, error: error.message };
        }
    }

    /**
     * Detiene navegaci√≥n
     */
    async stopNavigation() {
        try {
            await this.navigationController.stopAllSessions();
            return { success: true };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene estado actual de navegaci√≥n
     */
    async getNavigationStatus() {
        try {
            const status = await this.navigationController.getSessionsStatus();
            return { success: true, status };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    //#endregion NAVEGACI√ìN

    //#region DB
    /**
     * Obtiene estad√≠sticas de base de datos
     */
    async getDatabaseStats() {
        try {
            const stats = await this.databaseManager.getWebsiteStats();
            return { success: true, stats };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene sitios aleatorios
     */
    async getRandomSites(event, count = 10) {
        try {
            const sites = await this.databaseManager.getRandomWebsites(count);
            return { success: true, sites };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    //#endregion DB

    //#region CONFIGURACI√ìN
    /**
     * Obtiene configuraci√≥n
     */
    async getConfiguration() {
        try {
            const config = this.configManager.getConfig();
            return { success: true, config };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Actualiza configuraci√≥n
     */
    async updateConfiguration(event, updates) {
        try {
            Object.keys(updates).forEach(key => {
                this.configManager.set(key, updates[key]);
            });
            
            await this.configManager.saveConfig();
            return { success: true };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    //#endregion CONFIGURACI√ìN

    //#region SISTEMA
    /**
     * Muestra carpeta de datos
     */
    async showDataFolder() {
        const dataPath = this.configManager.getDatabasePath();
        shell.showItemInFolder(dataPath);
    }

    /**
     * Exporta logs
     */
    async exportLogs() {
        try {
            const result = await dialog.showSaveDialog(this.mainWindow, {
                defaultPath: `nexos-logs-${new Date().toISOString().split('T')[0]}.txt`,
                filters: [
                    { name: 'Archivos de texto', extensions: ['txt'] },
                    { name: 'Todos los archivos', extensions: ['*'] }
                ]
            });

            if (!result.canceled) {
                // Aqu√≠ implementar√≠as la exportaci√≥n de logs
                return { success: true, path: result.filePath };
            }

            return { success: false, error: 'Exportaci√≥n cancelada' };

        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    /**
     * Muestra di√°logo de error
     */
    showErrorDialog(title, message) {
        dialog.showErrorBox(title, message);
    }

    /**
     * Muestra di√°logo "Acerca de"
     */
    showAboutDialog() {
        dialog.showMessageBox(this.mainWindow, {
            type: 'info',
            title: 'Acerca de Cookies Hexzor',
            message: 'Cookies Hexzor v1.0.0',
            detail: 'Sistema automatizado para calentar contingencias\n¬© 2025 Todos los derechos reservados.'
        });
    }

    /**
     * Limpieza antes de cerrar
     */
    async cleanup() {
        try {
            console.log('üßπ Limpiando recursos...');
            
            if (this.navigationController) {
                await this.navigationController.stopAllSessions();
            }
            
            if (this.adsPowerManager) {
                await this.adsPowerManager.cleanup();
            }

            if (this.databaseManager) {
                await this.databaseManager.close();
            }

            console.log('‚úÖ Limpieza completada');

        } catch (error) {
            console.error('Error en limpieza:', error.message);
        }
    }
}
//#endregion SISTEMA

// Inicializar aplicaci√≥n
const electronApp = new ElectronApp();

// Prevenir creaci√≥n de ventanas adicionales para URLs
app.on('web-contents-created', (event, contents) => {
    contents.on('new-window', (event, navigationUrl) => {
        event.preventDefault();
        shell.openExternal(navigationUrl);
    });
});

// Inicializar cuando la app est√© lista
app.whenReady().then(() => {
    electronApp.initialize();
});